<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste do Chat em Tempo Real</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .chat-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        margin-top: 20px;
        margin-bottom: 20px;
        background-color: #fafafa;
      }
      .message {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
      }
      .message.own {
        background-color: #007bff;
        color: white;
        margin-left: auto;
      }
      .message.other {
        background-color: #e9ecef;
        color: #333;
      }
      .message-info {
        font-size: 0.8em;
        opacity: 0.7;
        margin-bottom: 2px;
      }
      .input-container {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        margin-bottom: 10px;
      }
      #messageInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 16px;
      }
      #nameInput {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 16px;
      }
      #saveNameButton {
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
      }
      #sendButton {
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
      }
      #sendButton:hover {
        background-color: #0056b3;
      }
      #sendButton:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .status {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
      }
      .status.connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .connection-info {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 15px;
      }
      #destinationSessionIdSelect {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 16px;
      }
      #sendWhisperButton {
        padding: 12px 24px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
      }
      #sendWhisperButton:hover {
        background-color: #0056b3;
      }
      #sendWhisperButton:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Chat em Tempo Real</h1>

      <div id="status" class="status disconnected">Desconectado</div>

      <div class="input-container">
        <input
          type="text"
          id="nameInput"
          placeholder="Digite seu nome aqui..."
        />
        <button id="saveNameButton">Salvar</button>
      </div>

      <div class="input-container">
        <select id="destinationSessionIdSelect">
          <option id="destinationSessionIdOption" value="">
            Selecione o destinat√°rio...
          </option>
        </select>
        <input
          type="text"
          id="whisperInput"
          placeholder="Digite seu sussurro aqui..."
        />
        <button id="sendWhisperButton">Enviar</button>
      </div>

      <div id="chatContainer" class="chat-container">
        <div style="text-align: center; color: #666; padding: 50px">
          Aguardando conex√£o...
        </div>
      </div>

      <div class="input-container">
        <input
          type="text"
          id="messageInput"
          placeholder="Digite sua mensagem aqui..."
          maxlength="500"
          disabled
        />
        <button id="sendButton" disabled>Enviar</button>
      </div>
    </div>

    <script>
      // Conecta ao servidor WebSocket
      const socket = io('http://localhost:3000', {
        // const socket = io('https://c7cc5722862d.ngrok-free.app', {
        transports: ['websocket', 'polling'],
        upgrade: true,
        rememberUpgrade: true,
        timeout: 20000,
        forceNew: true,
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5,
        maxReconnectionAttempts: 5,
      });

      const statusDiv = document.getElementById('status');
      const chatContainer = document.getElementById('chatContainer');
      const messageInput = document.getElementById('messageInput');
      const sendButton = document.getElementById('sendButton');
      const saveNameButton = document.getElementById('saveNameButton');
      const sendWhisperButton = document.getElementById('sendWhisperButton');

      let currentSessionId = null;

      // Eventos de conex√£o
      socket.on('connect', () => {
        statusDiv.textContent = 'Conectado';
        statusDiv.className = 'status connected';
        messageInput.disabled = false;
        sendButton.disabled = false;
        currentSessionId = socket.id;

        // Limpa o container de chat
        chatContainer.innerHTML = '';
      });

      socket.on('disconnect', (reason) => {
        console.log('‚ùå Desconectado do servidor!', reason);
        statusDiv.textContent = `Desconectado (${reason})`;
        statusDiv.className = 'status disconnected';
        messageInput.disabled = true;
        sendButton.disabled = true;
      });

      socket.on('connect_error', (error) => {
        console.error('‚ùå Erro de conex√£o:', error);
        statusDiv.textContent = `Erro de conex√£o: ${error.message}`;
        statusDiv.className = 'status disconnected';
        messageInput.disabled = true;
        sendButton.disabled = true;
      });

      socket.on('reconnect', (attemptNumber) => {
        console.log('üîÑ Reconectado ap√≥s', attemptNumber, 'tentativas');
        statusDiv.textContent = 'Reconectado';
        statusDiv.className = 'status connected';
        messageInput.disabled = false;
        sendButton.disabled = false;
      });

      socket.on('reconnect_attempt', (attemptNumber) => {
        console.log('üîÑ Tentativa de reconex√£o:', attemptNumber);
        statusDiv.textContent = `Tentando reconectar... (${attemptNumber})`;
        statusDiv.className = 'status disconnected';
      });

      socket.on('reconnect_error', (error) => {
        console.error('‚ùå Erro na reconex√£o:', error);
      });

      socket.on('reconnect_failed', () => {
        console.error('‚ùå Falha na reconex√£o');
        statusDiv.textContent = 'Falha na reconex√£o';
        statusDiv.className = 'status disconnected';
      });

      // Recebe hist√≥rico de mensagens quando conecta
      socket.on('history', (messages) => {
        console.log('Hist√≥rico recebido:', messages);
        chatContainer.innerHTML = '';

        if (messages && messages.length > 0) {
          messages.forEach((message) => {
            addMessageToChat(message, message.session === currentSessionId);
          });
        } else {
          chatContainer.innerHTML =
            '<div style="text-align: center; color: #666; padding: 50px;">Nenhuma mensagem no hist√≥rico</div>';
        }
      });

      // Recebe usu√°rios quando conecta
      socket.on('users', (users) => {
        console.log('Usu√°rios recebidos:', users);
        destinationSessionIdSelect.innerHTML = '';
        users.forEach((user) => {
          addUserToSelect(user);
        });
      });

      // Recebe novas mensagens em tempo real
      socket.on('receiveMessage', (data) => {
        console.log('Nova mensagem recebida:', data);
        if (data.Message) {
          addMessageToChat(
            data.Message,
            data.Message.session === currentSessionId,
          );
        }
      });

      socket.on('receiveWhisper', (data) => {
        console.log('Novo sussurro recebido:', data);
        if (data.Whisper) {
          addWhisperToChat(
            data.Whisper,
            data.Whisper.sessionId === currentSessionId,
          );
        }
      });

      function addUserToSelect(user) {
        const option = document.createElement('option');
        option.value = user.session;
        option.textContent = user.name;
        destinationSessionIdSelect.appendChild(option);
      }

      // Fun√ß√£o para adicionar mensagem ao chat
      function addMessageToChat(message, isOwn) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;

        const infoDiv = document.createElement('div');
        infoDiv.className = 'message-info';
        infoDiv.textContent = `${message.name} | ${new Date(message.Date).toLocaleString()}`;

        const textDiv = document.createElement('div');
        textDiv.textContent = message.Text;

        messageDiv.appendChild(infoDiv);
        messageDiv.appendChild(textDiv);

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function addWhisperToChat(message, isOwn) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;

        const infoDiv = document.createElement('div');
        infoDiv.className = 'message-info';
        infoDiv.textContent = `SUSSURRO DE ${message.fromName} | ${new Date(message.date).toLocaleString()}`;

        const textDiv = document.createElement('div');
        textDiv.textContent = message.text;

        messageDiv.appendChild(infoDiv);
        messageDiv.appendChild(textDiv);

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Enviar mensagem
      function sendMessage() {
        const text = messageInput.value.trim();
        if (text && socket.connected) {
          const messageData = {
            text: text,
            date: new Date().toISOString(),
          };

          socket.emit('sendMessage', messageData);
          messageInput.value = '';
        }
      }

      // Salvar nome
      function saveName() {
        const nameInput = document.getElementById('nameInput');
        const saveNameButton = document.getElementById('saveNameButton');
        if (nameInput.value && socket.connected) {
          console.log('Enviando nome:', nameInput.value);
          socket.emit('saveName', nameInput.value);

          nameInput.disabled = true;
          name = nameInput.value;

          saveNameButton.disabled = true;
          saveNameButton.textContent = 'Nome Salvo!';
          saveNameButton.style.backgroundColor = '#28a745';
        }
      }

      function sendWhisper() {
        const whisperInput = document.getElementById('whisperInput');
        const sendWhisperButton = document.getElementById('sendWhisperButton');
        const destinationSessionIdSelect = document.getElementById(
          'destinationSessionIdSelect',
        );
        if (whisperInput.value && socket.connected) {
          socket.emit('sendWhisper', {
            destinationSessionId: destinationSessionIdSelect.value,
            text: whisperInput.value,
          });
        }
      }

      // Event listeners
      sendButton.addEventListener('click', sendMessage);
      saveNameButton.addEventListener('click', saveName);
      sendWhisperButton.addEventListener('click', sendWhisper);
      messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      nameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          saveName();
        }
      });
      whisperInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendWhisper();
        }
      });

      // Mostra informa√ß√µes de debug no console
      console.log('=== INFORMA√á√ïES DO CHAT ===');
      console.log('Socket ID atual:', socket.id);
      console.log('Status da conex√£o:', socket.connected);
    </script>
  </body>
</html>
